すべてのテストが GREEN になった後にコードをリファクタリングします（TDD REFACTOR フェーズ）。

以下の手順に従ってください：

1. **引数の確認**:

   - `$ARGUMENTS`が提供されていることを確認
   - 提供されていない場合は直ちに終了し、イシュー番号引数を渡すように日本語でユーザーに促す

2. **すべてのテストが成功していることを確認**:

   - フルテストスイートを実行: `pytest`
   - 100%のテストが GREEN であることを確認
   - 失敗するテストがある場合は、リファクタリング前に修正

3. **コード品質の分析**:

   - リンターを実行: `ruff check . --show-source`
   - タイプチェッカーを実行: `pyright`
   - テストカバレッジをチェック: `pytest --cov=domain --cov=application --cov=infrastructure --cov=presentation`
   - 改善が必要な領域を特定

4. **ドメイン層のリファクタリング**:

   - エンティティと値オブジェクトの重複を除去
   - 共通の振る舞いをベースクラスに抽出
   - 複雑なメソッドを簡素化
   - ユビキタス言語が一貫して使用されていることを確認

   一般的なリファクタリング:

   - メソッドの抽出
   - クラスの抽出
   - マジックナンバーを定数で置き換え
   - 条件式の簡素化

5. **アプリケーション層のリファクタリング**:

   - ユースケースの複雑さを減らす
   - 共通のバリデーションロジックを抽出
   - エラーハンドリングの一貫性を改善
   - DTO 変換を最適化

6. **インフラストラクチャ層のリファクタリング**:

   - データベースクエリを最適化
   - 接続処理を改善
   - 共通のマッピングロジックを抽出
   - 適切な場所にキャッシュを追加

7. **プレゼンテーション層のリファクタリング**:

   - エラーレスポンスを標準化
   - 共通のバリデーションパターンを抽出
   - API の一貫性を改善
   - コントローラーの複雑さを減らす

8. **テストのリファクタリング**:

   - テストの重複を除去
   - テストフィクスチャとビルダーを抽出
   - テスト名と組織を改善
   - 欠けているエッジケーステストを追加

9. **横断的関心事**:

   - ログイングパターンを標準化
   - エラーメッセージを改善
   - パフォーマンス監視フックを追加
   - 一貫した命名規則を確保

10. **各変更後のテスト実行**:

- 小さく漸進的な変更を行う
- 各リファクタリング後に関連テストを実行
- 動作する状態を頻繁ににコミット

11. **ドキュメントの更新**:

    - アーキテクチャが変更された場合は設計ドキュメントを更新
    - 必要に応じてコードコメントを改善
    - API ドキュメントを更新

12. **パフォーマンス最適化**（必要な場合）:

    - 遅い操作をプロファイル
    - データベースクエリを最適化
    - 適切なインデックスを追加
    - 非同期操作を検討

13. **最終検証**:

    - フルテストスイートを再度実行
    - リンティングとタイプチェックを確認
    - テストカバレッジレポートを確認
    - 機能が壊れていないことを確認

14. **リファクタリングのサマリー作成**:

    - 行った主要な変更をドキュメント化
    - パフォーマンス改善を記録
    - 破壊的変更がある場合はリスト化

15. **イシューの更新**:
    - コメント: `gh issue comment $ARGUMENTS --body "リファクタリングを完了しました。すべてのテストは成功し、コード品質が向上しました。"`

重要な注意事項:

- GREEN テストなしではリファクタリングを絶対にしない
- 一度に一種類の変更のみ行う
- コミットを小さく焦点を絞ったものにする
- リファクタリングは振る舞いを変更すべきではない
- すべてのユーザー向け出力は日本語で行う必要があります
